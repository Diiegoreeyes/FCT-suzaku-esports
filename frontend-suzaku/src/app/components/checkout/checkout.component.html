<section class="checkout">
  <h2>üõçÔ∏è Confirmaci√≥n de Compra</h2>

  <!-- C√≥digo de Descuento -->
  <form (ngSubmit)="aplicarDescuento()" class="descuento-form">
    <input
      type="text"
      id="descuento"
      [(ngModel)]="codigoDescuento"
      name="descuento"
      placeholder="C√≥digo de descuento"
    />
    <button type="submit">Aplicar</button>
  </form>

  <!-- Lista de Productos -->
  <div *ngIf="productosEnCarrito.length > 0; else noProductos" class="productos-container">
    <div class="producto-card" *ngFor="let producto of productosEnCarrito">
      <img [src]="getProductoFoto(producto.foto)" class="producto-img" alt="{{ producto.nombre }}" />
      <div class="producto-detalles">
        <h3>{{ producto.nombre }}</h3>
        <p>Precio: {{ producto.precio }} ‚Ç¨</p>
        <p>Cantidad: {{ producto.cantidad }}</p>
        <p>Subtotal: {{ producto.precio * producto.cantidad | number:'1.2-2' }} ‚Ç¨</p>
      </div>
    </div>
  </div>

  <ng-template #noProductos>
    <p>Tu carrito est√° vac√≠o.</p>
  </ng-template>

  <!-- Total -->
  <div class="total-compra">
    <ng-container *ngIf="descuento > 0; else totalNormal">
      <p>
        <span class="precio-original">{{ total | currency:'EUR' }}</span>
        <span class="precio-descuento">{{ total - descuento | currency:'EUR' }}</span>
      </p>
    </ng-container>
    <ng-template #totalNormal>
      <p><strong>Total:</strong> {{ total | currency:'EUR' }}</p>
    </ng-template>
  </div>

  <!-- Direcci√≥n activa -->
  <div class="direccion-envio">
    <label>Direcci√≥n de env√≠o:</label>
    <div class="direccion-activa">
      {{ direccionActivaStr || 'No hay direcci√≥n activa' }}
    </div>
    <button type="button" (click)="cambiarDireccion()">Cambiar direcci√≥n</button>
  </div>

  <!-- Lista de direcciones -->
  <div *ngIf="mostrarSelectorDirecciones" class="selector-direcciones">
    <h4>Selecciona una direcci√≥n:</h4>
    <div *ngFor="let dir of direcciones" class="direccion-card">
      <p><strong>{{ dir.alias || 'Direcci√≥n' }}</strong></p>
      <p>{{ dir.direccion }}, {{ dir.ciudad }}, {{ dir.provincia }}</p>
      <p>{{ dir.codigo_postal }} - {{ dir.pais }}</p>
      <button (click)="seleccionarDireccion(dir)">Usar esta direcci√≥n</button>
    </div>

    <button (click)="toggleFormularioDireccion()">
      {{ mostrarFormularioDireccion ? 'Cancelar' : 'Agregar nueva direcci√≥n' }}
    </button>

    <!-- Formulario nueva direcci√≥n -->
    <form *ngIf="mostrarFormularioDireccion" [formGroup]="direccionForm" (ngSubmit)="agregarDireccion()">
      <div><label>Alias:</label><input formControlName="alias" /></div>
      <div><label>Direcci√≥n:</label><input formControlName="direccion" required /></div>
      <div><label>Ciudad:</label><input formControlName="ciudad" required /></div>
      <div><label>Provincia:</label><input formControlName="provincia" /></div>
      <div><label>C√≥digo Postal:</label><input formControlName="codigo_postal" /></div>
      <div><label>Pa√≠s:</label><input formControlName="pais" required /></div>
      <button type="submit">Guardar direcci√≥n</button>
    </form>
  </div>

  <!-- Acciones -->
  <div class="acciones">
    <button routerLink="/carrito" class="btn btn-secondary">‚¨ÖÔ∏è Volver</button>
    <button (click)="confirmarPedido()" class="btn btn-primary">Confirmar Pedido ‚úÖ</button>
  </div>
</section>
